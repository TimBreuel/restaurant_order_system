<!DOCTYPE html>
<html lang="zxx" class="no-js">
  <head>
    <%- include('partials/header') %>
  </head>
  <body>
    <!-- Modal -->
    <div
      class="modal fade"
      id="exampleModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">
              Your Selection
            </h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <ul class="list-group modal__orderList"></ul>
            <li
              class="list-group-item d-flex justify-content-between align-items-center"
              style="padding-right: 10px; font-weight: 700;"
            >
              Total Cost:<span class="badge badge-primary totalCost"> 0$</span>
            </li>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-outline-danger"
              data-dismiss="modal"
            >
              Close
            </button>
            <button
              class="btn btn-outline-primary"
              type="button"
              id="wantsToPay"
            >
              Call Service To Pay
            </button>
            <button type="button" class="btn btn-outline-primary payOnlineBtn">
              Pay Online
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="pos-f-t">
      <div class="collapse" id="navbarToggleExternalContent">
        <div class="bg-dark p-4">
          <h4 class="text-white">Your orders:</h4>
          <span class="text-muted"
            >When you want delete a meal click the x button</span
          >
          <ul class="ul-cart-list"></ul>
        </div>
      </div>
      <nav class="navbar navbar-dark bg-dark">
        <button
          class="navbar-toggler"
          type="button"
          data-toggle="collapse"
          data-target="#navbarToggleExternalContent"
          aria-controls="navbarToggleExternalContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class=""
            ><svg
              width="1em"
              height="1em"
              viewBox="0 0 16 16"
              class="bi bi-basket2-fill"
              fill="currentColor"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                fill-rule="evenodd"
                d="M11.314 1.036a.5.5 0 0 1 .65.278l2 5a.5.5 0 1 1-.928.372l-2-5a.5.5 0 0 1 .278-.65zm-6.628 0a.5.5 0 0 0-.65.278l-2 5a.5.5 0 1 0 .928.372l2-5a.5.5 0 0 0-.278-.65z"
              />
              <path
                fill-rule="evenodd"
                d="M1.5 7a.5.5 0 0 0-.489.605l1.5 7A.5.5 0 0 0 3 15h10a.5.5 0 0 0 .489-.395l1.5-7A.5.5 0 0 0 14.5 7h-13zM4 10a1 1 0 0 1 2 0v2a1 1 0 1 1-2 0v-2zm3 0a1 1 0 0 1 2 0v2a1 1 0 1 1-2 0v-2zm4-1a1 1 0 0 0-1 1v2a1 1 0 1 0 2 0v-2a1 1 0 0 0-1-1z"
              />
              <path
                d="M0 6.5A.5.5 0 0 1 .5 6h15a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5H.5a.5.5 0 0 1-.5-.5v-1z"
              />
            </svg>
          </span>
        </button>

        <button
          class="navbar-toggler"
          type="button"
          id="sendOrder"
          style="font-weight: 300; font-size: 18px;"
        >
          Send Order
        </button>
        <button
          class="navbar-toggler"
          type="button"
          id="needService"
          style="font-weight: 300; font-size: 18px;"
        >
          Need Service
        </button>

        <button
          type="button"
          class="navbar-toggler"
          style="font-weight: 300; font-size: 18px;"
          id="orderLogBtn"
        >
          Order Log & Pay
        </button>

        <button
          type="button"
          class="navbar-toggler"
          style="font-weight: 300; font-size: 18px;"
        >
          <a
            class="tableIdLogout"
            style="text-decoration: none; color: rgb(158, 158, 158);"
            href="/login/logout"
            restaurantid="<%= tableMenu[0].restaurantId %>"
            tableid="<%= tableMenu[0]._id %>"
            tablenumber="<%= tableMenu[0].table_number %>"
            >Table: #<%= tableMenu[0].table_number %> Logout</a
          >
        </button>
      </nav>
    </div>
    <div
      class="message text-center menu-area section-gap d-none"
      style="padding: 50px 0 30px 0; font-size: 28px;"
    >
      We have a problem
    </div>
    <!-- Start menu-area Area -->
    <section
      class="menu-area section-gap"
      id="menu"
      style="padding-top: 70px; height: 100vh; height: 100vh;"
    >
      <div class="container" style="padding-bottom: 100px;">
        <ul class="filter-wrap filters col-lg-12 no-padding">
          <li class="active" data-filter="*">All Menu</li>
          <li data-filter=".drinks">Drinks</li>
          <li data-filter=".breakfast">Breakfast</li>
          <li data-filter=".lunch">Lunch</li>
          <li data-filter=".dinner">Dinner</li>
        </ul>

        <div class="filters-content">
          <div class="row grid">
            <!-- JSX LOOP TO RENDER MENU -->
            <% tableMenu[1].forEach(meal => { %> <% if (meal.img !== '') { %>
            <div class="col-md-6 all <%= meal.category %>">
              <div class="single-menu">
                <div class="row">
                  <div class="col-md-4" style="padding: 0 0 0 0;">
                    <img
                      src="<%= meal.img %> "
                      alt=""
                      width="100%"
                      height="150px"
                      class="rounded"
                    />
                  </div>
                  <div class="col-md-8">
                    <div class="title-wrap d-flex justify-content-between">
                      <% if (meal.number !== '') { %>
                      <h4 mealId="<%= meal._id %>">
                        <%= meal.number %> <%= meal.title %>
                      </h4>
                      <h4 class="price">$<%= meal.price %></h4>
                      <% }else{ %>
                      <h4 mealId="<%= meal._id %>"><%= meal.title %></h4>
                      <h4 class="price">$<%= meal.price %></h4>
                      <% } %>
                    </div>
                    <p>
                      <%= meal.description %>
                    </p>
                    <button
                      class="btn btn-block bg-light addToCardBtn mt-5"
                      mealId="<%= meal._id %>"
                    >
                      ADD TO CART
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <% }else{ %>
            <div class="col-md-6 all <%= meal.category %>">
              <div class="single-menu">
                <div class="title-wrap d-flex justify-content-between">
                  <% if (meal.number !== '') { %>
                  <h4 mealId="<%= meal._id %>">
                    <%= meal.number %> <%= meal.title %>
                  </h4>
                  <h4 class="price">$<%= meal.price %></h4>
                  <% }else{ %>
                  <h4 mealId="<%= meal._id %>"><%= meal.title %></h4>
                  <h4 class="price">$<%= meal.price %></h4>
                  <% } %>
                </div>
                <p>
                  <%= meal.description %>
                </p>
                <button class="btn btn-block bg-light addToCardBtn mt-5">
                  ADD TO CART
                </button>
              </div>
            </div>
            <% } %> <% }) %>
          </div>
        </div>
      </div>
    </section>
    <!-- End menu-area Area -->

    <!-- start footer Area -->
    <%- include('partials/footer') %>
    <!-- End footer Area -->

    <%- include('partials/scripts') %>

    <script>
      let infoMessage = document.querySelector(".message");
      const tableIdLogout = document.querySelector(".tableIdLogout");
      //////////////////////
      //UI SELECTORS GLOBAL
      let ulCartList = document.querySelector(".ul-cart-list");
      /////////////////////////
      //ADD A MEAL TO THE CART
      const addToCardBtn = document.querySelectorAll(".addToCardBtn");
      addToCardBtn.forEach((btn) => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          let liElement = document.createElement("li");
          liElement.classList.add("orderListItem");
          liElement.innerHTML = `<h4 class="text-white" mealId="${e.target.parentElement.children[0].children[0].getAttribute(
            "mealId"
          )}"><span class="deleteMealItem text-danger">X</span> ${
            e.target.parentElement.children[0].children[0].innerText
          }</h4>`;
          ulCartList.prepend(liElement);
          liElement.children[0].children[0].addEventListener("click", (e) => {
            e.preventDefault();
            e.target.parentElement.parentElement.remove();
          });
        });
      });
      ////////////////////////////
      //SEND ORDER TO THE DATABASE
      const sendOrder = document.querySelector("#sendOrder");
      sendOrder.addEventListener("click", (e) => {
        let orderListItem = document.querySelectorAll(".orderListItem");
        let orderListArr = [];
        orderListItem.forEach((orderItem) => {
          // console.log(orderItem.children[0].getAttribute("mealId"));
          orderListArr.push(orderItem.children[0].getAttribute("mealId"));
        });

        let data = {
          restaurantId: tableIdLogout.getAttribute("restaurantId"),
          tableId: tableIdLogout.getAttribute("tableid"),
          tableNumber: tableIdLogout.getAttribute("tablenumber"),
          order: orderListArr,
        };

        postDataTable("/login/table/sendOrder", data).then((response) => {
          if (response === 1) {
            ulCartList.innerHTML = "";
            infoMessage.innerText = "Your Order Have Been Send To The Kitchen";
            infoMessage.classList.remove("d-none");
            infoMessage.classList.add("text-success");
            setTimeout(() => {
              infoMessage.classList.add("d-none");
              infoMessage.classList.remove("text-success");
            }, 5000);
          } else {
            infoMessage.innerText = "Something goes wrong";
            infoMessage.classList.remove("d-none");
            infoMessage.classList.add("text-danger");
            setTimeout(() => {
              infoMessage.classList.add("d-none");
              infoMessage.classList.remove("text-danger");
            }, 5000);
          }
        });
      });

      /////////////////
      //SET SERVICE BTN
      const needServiceBtn = document.querySelector("#needService");
      needServiceBtn.addEventListener("click", (e) => {
        e.preventDefault();
        let needServiceData = {
          tableId: tableIdLogout.getAttribute("tableid"),
          neddService: true,
        };
        postDataTable("/login/table/needService", needServiceData).then(
          (response) => {
            if (response === 1) {
              infoMessage.innerText = "The Service Is Contacted";
              infoMessage.classList.remove("d-none");
              infoMessage.classList.add("text-warning");
              setTimeout(() => {
                infoMessage.classList.add("d-none");
                infoMessage.classList.remove("text-warning");
              }, 5000);
            } else {
              infoMessage.innerText = "Something goes wrong";
              infoMessage.classList.remove("d-none");
              infoMessage.classList.add("text-danger");
              setTimeout(() => {
                infoMessage.classList.add("d-none");
                infoMessage.classList.remove("text-danger");
              }, 5000);
            }
          }
        );
      });

      //////////////////
      //SET WANT TO PAY
      const wantsToPay = document.querySelector("#wantsToPay");
      wantsToPay.addEventListener("click", (e) => {
        e.preventDefault();
        let wantsToPayData = {
          tableId: tableIdLogout.getAttribute("tableid"),
          wantsToPay: true,
        };
        postDataTable("/login/table/wantsToPay", wantsToPayData).then(
          (response) => {
            if (response === 1) {
              infoMessage.innerText =
                "The service is contacted that you want to pay";
              infoMessage.classList.remove("d-none");
              infoMessage.classList.add("text-primary");
              setTimeout(() => {
                infoMessage.classList.add("d-none");
                infoMessage.classList.remove("text-primary");
              }, 5000);
            } else {
              infoMessage.innerText = "Something goes wrong";
              infoMessage.classList.remove("d-none");
              infoMessage.classList.add("text-danger");
              setTimeout(() => {
                infoMessage.classList.add("d-none");
                infoMessage.classList.remove("text-danger");
              }, 5000);
            }
          }
        );
      });
      /////////////
      //TOTAL COST
      let totalCost = document.querySelector(".totalCost");
      /////////////////
      //ORDER LOG MODAL
      const orderLogBtn = document.querySelector("#orderLogBtn");
      orderLogBtn.addEventListener("click", (e) => {
        e.preventDefault();

        let data = {
          tableId: tableIdLogout.getAttribute("tableid"),
          restaurantId: tableIdLogout.getAttribute("restaurantId"),
        };
        postDataTable("/login/table/orderLog", data).then((response) => {
          if (!response === 2) {
            console.log("ERROR");
          } else {
            showModalOrderLog(response);
          }
        });
      });

      const payOnlineBtn = document.querySelector(".payOnlineBtn");
      payOnlineBtn.addEventListener("click", (e) => {
        e.preventDefault();
        window.open("https://www.paypal.com", "_blank");
      });

      /////////////////
      //MODAL FUNCTION
      function showModalOrderLog(orderAll) {
        const modal = document.querySelector("#exampleModal");
        let modalOrderList = document.querySelector(".modal__orderList");
        modalOrderList.innerHTML = "";
        let totalCostNum = totalCost.innerText;
        totalCostNum = parseInt(totalCostNum);

        orderAll.forEach((order) => {
          totalCostNum += order.price;
          const liElement = document.createElement("div");
          liElement.innerHTML = `<li class="list-group-item d-flex justify-content-between align-items-center" style="border-left:0;border-right:0; padding:10px">${order.title}<span class="badge badge-secondary">${order.price} $</span></li>`;
          modalOrderList.append(liElement);
        });
        totalCost.innerText = totalCostNum + " €";
        $("#exampleModal").modal("show");
      }

      /////////////////////
      //FETCH DATA FUNCTION
      async function postDataTable(url = "", data = {}) {
        const response = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        });
        return response.json();
      }
    </script>
  </body>
</html>
